# File Introduction
    ├── PULP-Lite Ccode
    │   ├── Ccode                        // The C code of CNN, KNN, LR, LSBoost, SVM and NB
    │   ├── download                     // C code generation file. If C code compilation fails, you can download the file from the folder download to PULP-Lite
    │   ├── experimental data            // The experimental data of CNN, KNN, LR, LSBoost, SVM and NB
    │   └── readme.md
    ├── PULP-Lite FPGA
    │   ├── readme.md 
    │   ├── vivado2020.2Project          // the FPGA project of PULP-Lite based on vivado2020.2.
    │   └── vivado_Bitstream             // If it is failed to restore the project, you can download the Bitstream in the folder vivado_Bitstream.


# Operation process

    1, Choose the interconnection of PULP Lite
    2, Restore the FPGA project        // If it is failed to restore the project, you can download the Bitstream in the folder PULP-Lite FPGA\vivado_Bitstream.
    3, Prepare a computer that meets the requirements for compiling C code
    4, Modify PULP-Lite Ccode\Ccode\CNNMnist_v2\BUILD\file_c\debug.h to generate different code.
    5, Compile C code                  // If C code compilation fails, you can download the file from the folder PULP-Lite Ccode\download to PULP-Lite
    6, Change the value of FPGA boot pin into boot mode
    7, Connect the Uart pin to the PC
    8, Download experimental program



# 1. Choose Interconnection of PULP-Lite

Modify the value of  MUT_IMP in PULP-Lite FPGA\vivado2020.2Project\RTL\noc\defaults.svh to Select the interconnection structure of PULP-Lite 

    `define MUT_IMPL 0      // xbar
    `define MUT_IMPL 1      // bfly2
    `define MUT_IMPL 2      // bfly4
    `define MUT_IMPL 3      // clos_m2n
    `define MUT_IMPL 4      // clos_m1n
    `define MUT_IMPL 5      // clos_m0p5n

# 2. Restore the FPGA project
To restore the project, follow the steps below on Vivado2020.2.
The FPGA is xcku060-ffva1156-2-i.
   
    ​1， Click  Tools ---> Run Tcl Scripts
    2， Select fpga_simtest.tcl  //  if recovery is not possible, it is necessary to determine whether the path to the source code file in the cl file is correct.
    3， Modify the value of  MUT_IMP in defaults.svh to Select the interconnection structure of PULP-Lite. 
    4， Click  Generate Bitstream
    5， Download BitStream to FPGA

# 3. Prepare a computer that meets the requirements for compiling C code
    1. Ubuntu20.04.1
    2. riscv32-unknown-elf-gcc 7.1.1
    3. python3.8

# 4. Modify PULP-Lite Ccode\Ccode\CNNMnist_v2\BUILD\file_c\debug.h to generate different code

    #define CORE_NUM 1          // CPU0 executes all code
    #define CORE_NUM 8          // CPU0-7 execute all code in parallel
    #define CORE17_IRQ          // CPU1-7 queries tasks through interrupts
    // #define CORE17_IRQ       // CPU1-7 queries tasks through round-robin
    #define NOC_ADDR_TR 1       // enable address translation in the shared stack
    #define NOC_ADDR_TR 2       // disable address translation in the shared stack


# 5. Compile C code 
The optimization level for compiling is -O0 and the ISA used is RV32IMC. These settings have already been configured in the file "Pulp-Lite\PULP-Lite_Ccode\Ccode\CNNMnist_v2\BUILD\C2SO.py".
Compile C code by the command: “make EXhex user_code”

# 6. Change the value of FPGA boot pin into boot mode
    boot mode   :         Set FPGA boot pin to 0
    user mode   :         Set FPGA boot pin to 1
The definitions of all FPGA pins are located in "Pulp-Lite\PULP-Lite_FPGA\vivado2020.2Project\fpga_simtest.srcs\constrs_1\imports\new\pin.xdc". The UART pins of PULP-Lite are defined as follows:
set_property PACKAGE_PIN AM21 [get_ports boot]
# 7. Connect the Uart pin to the PC. 
The definitions of all FPGA pins are located in "Pulp-Lite\PULP-Lite_FPGA\vivado2020.2Project\fpga_simtest.srcs\constrs_1\imports\new\pin.xdc". The UART pins of PULP-Lite are defined as follows:
    set_property PACKAGE_PIN AK31 [get_ports uart_tx]
    set_property PACKAGE_PIN AK32 [get_ports uart_rx]

# 8. Download experimental program 
    Download the machine code of the program generated by compiling C code to FPGA through the serial port with the baud rate of 115200. 
 
    Please send mem_user.dat first, then rodata_user.dat.

# 9. Change the value of FPGA boot pin into user mode
    boot mode   :         Set FPGA boot pin to 0
    user mode   :         Set FPGA boot pin to 1

# 10. Reset PULP-Lite
    After resetting PULP-Lite, the downloaded program will be executed. All experimental results will be automatically sent to the PC via Uart, including the machine learning algorithm inference results, program running time, and the number of accesses to on-chip interconnect ports.


To Run the same algorithms on GAP8 for comparison, please follow the steps:

1. Create a fresh Ubuntu 20.04 (Focal Fossa) 64-Bit virtual machine from OS-Boxes.

2. Copy GAP8 files to the directory for building the GAP8 development environment and open this directory. Then, run the GAP8_download.sh in super user mode to download the GAP8 development environment including GAP RISC-V toolchain and GAP SDK. After this step, the GAP_SDK will be added to the environment variable to configure the shell environment correctly for the GAP SDK.

3. Use the command of "GAP_SDK" (it has been added to the environment variable) to configure the shell environment correctly for the GAP SDK of GAPUINO_V2(Enter 8 to select GAPUINO_V2). It must be done before any terminal session for GAP8.

4. Run the GAP8_make.sh in super user mode to compile the GAP SDK after configuring the shell environment correctly for the GAP SDK of GAPUINO_V2.

5. Run the GAP8_test.sh to test the GAP8 development environment by compiling and running helloworld. This step must be done after configuring the shell environment correctly for the GAP SDK of GAPUINO_V2 and connecting the GAP8 board.

6. Open the C source code directory you want to compile and run, then use command "make CAR" to compile and run the C source code on GAP8 board. The command "make CAR" use the makefile to configure the experimental parameters according to our paper during the compilation process. This step must be done after configuring the shell environment correctly for the GAP SDK of GAPUINO_V2 and connecting the GAP8 board. 

7. If the program has been run correctly, the terminal will print the data received from the serial port connected to GAP8 board. These data include running frequency (the default is 50MHz that is the same as Pulp-Lite), program results and the number of running cycles, which are the experiment results of GAP8. You can compare the program results to our result screenshots for verification and divide the number of running cycles by the running frequency to obtain program runtime of GAP8.

For more details, please refer to readme.md in Pulp-Lite code directory.

